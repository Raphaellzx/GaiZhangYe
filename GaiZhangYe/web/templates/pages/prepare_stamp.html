<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>准备盖章页 - 盖章页工具</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/htsc-theme.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>准备盖章页</h1>
            <div class="top-actions">
                <button class="back-btn" onclick="window.location.href='/'">返回首页</button>
                <button class="btn btn-danger" onclick="shutdownServer()">终止服务</button>
            </div>
        </header>

        <div class="content">
            <!-- 使用说明（操作顺序） -->
                <div class="instructions instruction-box">
                <h3>使用教程（操作顺序）</h3>
                <ol>
                    <li>页面将自动列出；在每个文件的输入框中填写要提取的页码范围，例如 <code>1,3,5-7</code>（支持单页/逗号/区间）。</li>
                </ol>
            </div>

            <!-- 目录操作区 -->
            <div class="directory-section">
                <h3>选择Word文件目录</h3>
                <div class="folder-picker-container">
                    <div class="folder-input-group">
                        <input type="text" id="folderPath" placeholder="例如：D:\myfiles\documents" class="folder-input">
                        <button class="btn btn-success" onclick="scanFolder()">扫描文件</button>
                    </div>
                    <div id="loadingSpinner" class="loading-spinner" style="display: none;">
                        <div class="spinner"></div>
                        <p>正在扫描文件中...</p>
                    </div>
                    <div id="scanStatus" class="scan-status"></div>
                </div>

                <h3 style="margin-top: 30px;">输出位置设置</h3>
                <div class="folder-picker-container">
                    <div class="folder-input-group">
                        <input type="text" id="outputPath" placeholder="输出PDF位置（默认为用户文档文件夹）" class="folder-input">
                        <button class="btn" onclick="resetOutputPath()">使用默认</button>
                    </div>
                </div>
            </div>

            <!-- 文件列表区 -->
            <div class="file-list">
                <h3>目录文件及设置</h3>
                <div id="fileListContainer">
                    <p class="text-muted">请先选择文件夹并扫描</p>
                </div>
            </div>

            <!-- 结果区 -->
            <div id="result" class="result"></div>
        </div>

        <footer>
            <p>盖章页工具 © 2025-2026</p>
        </footer>
    </div>

    <script>
        let scannedFiles = [];
        let outputPath = ''; // 存储选择的输出路径

        // 初始化输出路径为用户文档文件夹，并处理后端会话切换（用于清理缓存）
        window.addEventListener('load', function() {
            // 检查后端会话ID，若变化则清理本地缓存
            fetch('/api/session-id')
            .then(r => r.json())
            .then(data => {
                try {
                    const serverSession = data.session_id;
                    const localSession = localStorage.getItem('app_session_id');
                    if (!localSession || localSession !== serverSession) {
                        // 清理与应用相关的缓存键（保留其它站点/域的localStorage）
                        const keysToClear = [
                            'prepare_output_path',
                            'stamp_overlay_result_word_path',
                            'stamp_overlay_result_pdf_path',
                            'word_to_pdf_word_dir',
                            'word_to_pdf_pdf_dir',
                            'stamp_overlay_config'
                        ];
                        keysToClear.forEach(k => localStorage.removeItem(k));
                        localStorage.setItem('app_session_id', serverSession);
                    }
                } catch (e) {
                    console.warn('session check failed', e);
                }

                // 从缓存或服务器获取默认输出路径
                const cached = localStorage.getItem('prepare_output_path');
                if (cached) {
                    outputPath = cached;
                    document.getElementById('outputPath').value = outputPath;
                    return;
                }

                fetch('/api/get-default-output-path', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.path) {
                        outputPath = data.path;
                        document.getElementById('outputPath').value = outputPath;
                    }
                })
                .catch(error => {
                    console.error('获取默认输出路径失败:', error);
                });
            })
            .catch(err => {
                console.error('session check failed', err);
            });
        });

        // 重置输出路径为默认
        function resetOutputPath() {
            fetch('/api/get-default-output-path', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.path) {
                    outputPath = data.path;
                    document.getElementById('outputPath').value = outputPath;
                    localStorage.setItem('prepare_output_path', outputPath);
                }
            })
            .catch(error => {
                console.error('获取默认输出路径失败:', error);
            });
        }

        // 浏览输出文件夹
        function browseOutputFolder() {
            const input = document.createElement('input');
            input.type = 'file';
            input.webkitdirectory = true;
            input.multiple = true;
            input.style.display = 'none';
            document.body.appendChild(input);
            
            input.onchange = (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    const file = e.target.files[0];
                    let folderPath = '';
                    
                    if (file.path) {
                        // Chrome/Edge/Firefox 支持path属性
                        const lastIndex = file.path.lastIndexOf(file.name);
                        folderPath = file.path.substring(0, lastIndex).trim();
                        outputPath = folderPath;
                        document.getElementById('outputPath').value = outputPath;
                        localStorage.setItem('prepare_output_path', outputPath);
                    } else if (file.webkitRelativePath) {
                        // 浏览器不支持完整路径，提示用户手动输入
                        const dirName = file.webkitRelativePath.split('/')[0];
                        const manualPath = prompt('您的浏览器无法自动获取完整路径。\\n\\n检测到文件夹名: ' + dirName + '\\n\\n请输入完整的输出文件夹路径（例如：D:\\\\Documents）:', dirName);
                        
                        if (manualPath) {
                            outputPath = manualPath;
                            document.getElementById('outputPath').value = outputPath;
                            localStorage.setItem('prepare_output_path', outputPath);
                        }
                    }
                }
                document.body.removeChild(input);
            };
            
            input.click();
        }

        // 浏览文件夹
        function browseFolder() {
            const input = document.createElement('input');
            input.type = 'file';
            input.webkitdirectory = true;
            input.multiple = true;
            input.style.display = 'none';
            document.body.appendChild(input);
            
            input.onchange = (e) => {
                if (e.target.files && e.target.files.length > 0) {
                    const file = e.target.files[0];
                    let folderPath = '';
                    
                    if (file.path) {
                        // Chrome/Edge/Firefox 支持path属性
                        const lastIndex = file.path.lastIndexOf(file.name);
                        folderPath = file.path.substring(0, lastIndex).trim();
                        document.getElementById('folderPath').value = folderPath;
                    } else if (file.webkitRelativePath) {
                        // 浏览器不支持完整路径，提示用户手动输入
                        const dirName = file.webkitRelativePath.split('/')[0];
                        const manualPath = prompt('您的浏览器无法自动获取完整路径。\\n\\n检测到文件夹名: ' + dirName + '\\n\\n请输入完整的Word文件夹路径（例如：D:\\\\data\\\\Word）:', dirName);
                        
                        if (manualPath) {
                            document.getElementById('folderPath').value = manualPath;
                        }
                    }
                }
                document.body.removeChild(input);
            };
            
            input.click();
        }

        // 扫描文件夹
        async function scanFolder() {
            const folderPath = document.getElementById('folderPath').value.trim();
            const statusDiv = document.getElementById('scanStatus');
            const spinner = document.getElementById('loadingSpinner');

            if (!folderPath) {
                statusDiv.className = 'scan-status error';
                statusDiv.textContent = '请输入文件夹路径';
                return;
            }

            // 显示加载spinner
            spinner.style.display = 'flex';
            statusDiv.textContent = '';

            try {
                const response = await fetch('/api/scan-folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ path: folderPath })
                });

                const data = await response.json();
                spinner.style.display = 'none';

                if (data.success) {
                    scannedFiles = data.files;
                    statusDiv.className = 'scan-status success';
                    statusDiv.textContent = `成功扫描到 ${scannedFiles.length} 个Word文件`;
                    populateFileList(scannedFiles);
                } else {
                    statusDiv.className = 'scan-status error';
                    statusDiv.textContent = '扫描失败: ' + data.error;
                    document.getElementById('fileListContainer').innerHTML = '<p class="text-muted">扫描失败</p>';
                }
            } catch (error) {
                spinner.style.display = 'none';
                statusDiv.className = 'scan-status error';
                statusDiv.textContent = '扫描出错: ' + error.message;
                document.getElementById('fileListContainer').innerHTML = '<p class="text-muted">扫描出错</p>';
            }
        }

        // 动态生成文件列表
        function populateFileList(files) {
            const container = document.getElementById('fileListContainer');

            if (files.length === 0) {
                container.innerHTML = '<p class="text-muted">该文件夹中没有Word文件</p>';
                return;
            }

            let html = '<form id="prepareForm">';
            files.forEach((file, index) => {
                // 默认选择最后一页
                const defaultPageValue = file.page_count || '1';
                html += `
                    <div class="file-item">
                        <div class="file-name-column">${file.name}</div>
                        <div class="page-count-column">共 ${file.page_count || '未知'} 页</div>
                        <div class="page-range">
                            <input type="text" id="page-${index}" name="${file.stem}" placeholder="如：1,3,5-7" class="page-input" value="${defaultPageValue}">
                            <button type="button" class="save-btn" onclick="convertRange('page-${index}')">保存</button>
                            <span id="parsed-${index}" class="parsed-text"></span>
                        </div>
                    </div>
                `;
            });
            html += '<button type="button" class="btn btn-success" style="margin-top: 20px;" onclick="submitForm()">开始提取</button></form>';
            container.innerHTML = html;
            
            // 自动保存所有文件的页码范围
            files.forEach((file, index) => {
                convertRange(`page-${index}`);
            });
        }

        // 解析页面范围字符串为数组
        function parsePageRange(rangeStr) {
            const pages = new Set();
            const parts = rangeStr.split(',');

            for (const part of parts) {
                const trimmedPart = part.trim();
                if (!trimmedPart) continue;

                if (trimmedPart.includes('-')) {
                    const [start, end] = trimmedPart.split('-').map(Number);
                    if (!isNaN(start) && !isNaN(end) && start <= end) {
                        for (let i = start; i <= end; i++) {
                            pages.add(i);
                        }
                    }
                } else {
                    const page = Number(trimmedPart);
                    if (!isNaN(page)) {
                        pages.add(page);
                    }
                }
            }

            return Array.from(pages).sort((a, b) => a - b);
        }

        // 转换并显示范围
        function convertRange(inputId) {
            const input = document.getElementById(inputId);
            const parsedSpan = document.getElementById('parsed-' + inputId.split('-')[1]);
            const rangeStr = input.value;
            const pages = parsePageRange(rangeStr);

            if (pages.length > 0) {
                parsedSpan.textContent = '已解析：' + pages.join(', ');
            } else {
                parsedSpan.textContent = '';
            }
        }

        // 提交表单
        function submitForm() {
            const form = document.getElementById('prepareForm');
            const formData = new FormData(form);
            const targetPages = {};
            const resultDiv = document.getElementById('result');

            // 验证输出路径
            const outputPathValue = document.getElementById('outputPath').value.trim();
            if (!outputPathValue) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '请选择输出路径';
                return;
            }

            // 解析表单数据
            for (const [key, value] of formData.entries()) {
                if (value.trim()) {
                    const pages = parsePageRange(value);
                    if (pages.length > 0) {
                        targetPages[key] = pages;
                    }
                }
            }

            if (Object.keys(targetPages).length === 0) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '请至少选择一个文件的页面范围';
                return;
            }

            // 显示加载spinner
            document.getElementById('loadingSpinner').style.display = 'flex';

            // 发送请求到API
            // 显示准备中的文本信息，类似 stamp_overlay 页面
            resultDiv.className = 'result-info';
            resultDiv.textContent = '正在准备中...';
            fetch('/api/prepare-stamp', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    target_pages: targetPages,
                    output_path: outputPathValue,
                    // 将当前选择的Word目录一并传给后端（如果用户指定）
                    word_dir: document.getElementById('folderPath').value.trim() || undefined
                })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('loadingSpinner').style.display = 'none';
                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = '提取完成！已生成文件：' + data.files.join(', ');
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '提取失败: ' + data.error;
                }
            })
            .catch(error => {
                document.getElementById('loadingSpinner').style.display = 'none';
                console.error('Error:', error);
                resultDiv.className = 'result error';
                resultDiv.textContent = '提取失败: ' + error.message;
            });
        }

        // 终止服务并关闭页面
        function shutdownServer() {
            if (confirm('确定要终止服务并关闭页面吗？')) {
                fetch('/api/shutdown', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('服务已终止，请关闭页面');
                        // 关闭当前页面
                        window.close();
                    } else {
                        alert('终止服务失败: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('终止服务失败');
                });
            }
        }
    </script>
</body>
</html>