<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>盖章页覆盖 - 盖章页工具</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/htsc-theme.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>盖章页覆盖</h1>
            <div class="top-actions">
                <button class="back-btn" onclick="window.location.href='/'">返回首页</button>
                <button class="btn btn-danger" onclick="shutdownServer()">终止服务</button>
            </div>
        </header>

        <div class="content">
            <div class="instructions">
                <h4>说明</h4>
                <p>获得发行人盖章页或项目组签字页后，需要打印后落上日期并进行扫描，将对应的图片插入到Word文档中。</p>
                <p>本工具可批量处理多个Word文件，并支持自定义每个文件的图片插入位置。</p>
                <p>用户在扫描前，将需要处理的word放入一个目录下，按照Windows资源管理器中名称从小到大的顺序整理盖/签字页，再进行扫描。</p>
                <p>图片插入位置默认为该文档最后一页（可输入具体页码）。例如 <code>1,3,5-7</code>（支持单页/逗号/区间）。</p>
            </div>

            <div class="config-section">
                <h2>文件和文件夹选择</h2>

                <!-- 文件夹选择区 -->
                <div class="folder-selection-area">
                    <div class="folder-section">
                        <h3>1️⃣ 选择Word文件目录</h3>
                        <p class="folder-hint">请输入包含需要盖章的Word文件（.docx或.doc）的文件夹路径</p>
                        <div class="folder-picker-container">
                            <div class="folder-input-group">
                                <input type="text" id="wordFolderPath" placeholder="例如：D:\myfiles\documents" class="folder-input">
                                <button class="btn btn-success" onclick="scanWordFiles()">扫描文件</button>
                            </div>
                            <div id="loadingSpinner" class="loading-spinner" style="display: none;">
                                <div class="spinner"></div>
                                <p>正在扫描文件中...</p>
                            </div>
                            <div id="wordScanStatus" class="scan-status"></div>
                        </div>
                    </div>

                    <div class="folder-section">
                        <h3>2️⃣ 选择盖章PDF文件</h3>
                        <p class="folder-hint">选择一个PDF文件，程序将自动从中提取图片到同目录下的文件夹中</p>
                        <div class="folder-picker-container">
                            <div class="folder-input-group">
                                <input type="text" id="pdfFilePath" placeholder="例如：D:\stamps\stamp.pdf" class="folder-input">
                                <button class="btn btn-success" onclick="extractPdfImages()">从PDF提取图片</button>
                            </div>
                            <div id="pdfExtractionStatus" class="scan-status"></div>
                        </div>
                    </div>
                </div>

                <h2>配置管理</h2>

                <!-- 配置表格 -->
                <div class="config-table-container">
                    <h3>对应关系配置</h3>
                    <table class="config-table" id="config-table">
                        <thead>
                            <tr>
                                <th>Word文件和图片配置</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="config-table-body"></tbody>
                    </table>
                </div>

                <!-- 配置操作按钮 -->
                <div class="config-actions">
                    <button class="btn" onclick="generateDefaultConfig()">生成默认配置</button>
                    <button class="btn" onclick="updateConfig()">保存配置</button>
                </div>
            </div>

            <div class="operations">
                <h3>输出位置设置</h3>
                <div class="folder-picker-container">
                    <div class="folder-input-group">
                        <label>Word文件输出位置：</label>
                        <input type="text" id="resultWordPath" placeholder="输出Word位置（默认为结果目录）" class="folder-input">
                        <button class="btn" onclick="resetResultWordPath()">使用默认</button>
                    </div>
                </div>
                <div class="folder-picker-container" style="margin-top: 15px;">
                    <div class="folder-input-group">
                        <label>PDF文件输出位置：</label>
                        <input type="text" id="resultPdfPath" placeholder="输出PDF位置（默认为结果目录）" class="folder-input">
                        <button class="btn" onclick="resetResultPdfPath()">使用默认</button>
                    </div>
                </div>

                <button class="btn btn-success" onclick="startProcessing()">开始覆盖</button>
                <button class="btn btn-warning" onclick="if(confirm('确定要清除本页面的所有缓存数据吗？')) { clearCache(); alert('缓存已清除，请刷新页面'); }">清除缓存</button>

                <div id="result"></div>
            </div>
        </div>

        <footer>
            <p>盖章页工具 © 2025-2026</p>
        </footer>
    </div>

    <script>
        // ==================== 数据缓存管理 ====================
        const CACHE_KEY_PREFIX = 'stamp_overlay_';
        
        // 缓存键定义
        const CACHE_KEYS = {
            WORD_FOLDER: CACHE_KEY_PREFIX + 'word_folder',
            PDF_FILE: CACHE_KEY_PREFIX + 'pdf_file',
            WORD_FILES: CACHE_KEY_PREFIX + 'word_files',
            IMAGE_FILES: CACHE_KEY_PREFIX + 'image_files',
            EXTRACTED_FOLDER: CACHE_KEY_PREFIX + 'extracted_folder',
            RESULT_WORD_PATH: CACHE_KEY_PREFIX + 'result_word_path',
            RESULT_PDF_PATH: CACHE_KEY_PREFIX + 'result_pdf_path',
            CONFIG: CACHE_KEY_PREFIX + 'config'
        };
        
        // 从localStorage加载数据
        function loadFromCache() {
            try {
                const wordFolder = localStorage.getItem(CACHE_KEYS.WORD_FOLDER);
                const pdfFile = localStorage.getItem(CACHE_KEYS.PDF_FILE);
                const wordFilesStr = localStorage.getItem(CACHE_KEYS.WORD_FILES);
                const imageFilesStr = localStorage.getItem(CACHE_KEYS.IMAGE_FILES);
                const extractedFolder = localStorage.getItem(CACHE_KEYS.EXTRACTED_FOLDER);
                const resultWord = localStorage.getItem(CACHE_KEYS.RESULT_WORD_PATH);
                const resultPdf = localStorage.getItem(CACHE_KEYS.RESULT_PDF_PATH);
                const configStr = localStorage.getItem(CACHE_KEYS.CONFIG);
                
                // 恢复输入框的值
                if (wordFolder) {
                    document.getElementById('wordFolderPath').value = wordFolder;
                }
                if (pdfFile) {
                    document.getElementById('pdfFilePath').value = pdfFile;
                }
                
                // 恢复全局变量
                if (wordFilesStr) {
                    wordFiles = JSON.parse(wordFilesStr);
                }
                if (imageFilesStr) {
                    imageFiles = JSON.parse(imageFilesStr);
                }
                if (extractedFolder) {
                    extractedImagesFolderPath = extractedFolder;
                }
                if (resultWord) {
                    resultWordPath = resultWord;
                    document.getElementById('resultWordPath').value = resultWordPath;
                }
                if (resultPdf) {
                    resultPdfPath = resultPdf;
                    document.getElementById('resultPdfPath').value = resultPdfPath;
                }
                if (configStr) {
                    currentConfig = JSON.parse(configStr);
                }
                
                // 如果有缓存的数据，重新初始化配置表格
                if (wordFiles.length > 0) {
                    initializeConfigTable();
                }
            } catch (error) {
                console.error('从缓存加载数据失败:', error);
            }
        }
        
        // 保存数据到localStorage
        function saveToCache() {
            try {
                localStorage.setItem(CACHE_KEYS.WORD_FOLDER, document.getElementById('wordFolderPath').value);
                localStorage.setItem(CACHE_KEYS.PDF_FILE, document.getElementById('pdfFilePath').value);
                localStorage.setItem(CACHE_KEYS.WORD_FILES, JSON.stringify(wordFiles));
                localStorage.setItem(CACHE_KEYS.IMAGE_FILES, JSON.stringify(imageFiles));
                localStorage.setItem(CACHE_KEYS.EXTRACTED_FOLDER, extractedImagesFolderPath);
                localStorage.setItem(CACHE_KEYS.RESULT_WORD_PATH, resultWordPath);
                localStorage.setItem(CACHE_KEYS.RESULT_PDF_PATH, resultPdfPath);
                localStorage.setItem(CACHE_KEYS.CONFIG, JSON.stringify(currentConfig));
            } catch (error) {
                console.error('保存数据到缓存失败:', error);
            }
        }
        
        // 清除缓存
        function clearCache() {
            try {
                Object.values(CACHE_KEYS).forEach(key => {
                    localStorage.removeItem(key);
                });
                console.log('缓存已清除');
            } catch (error) {
                console.error('清除缓存失败:', error);
            }
        }

        // ==================== 全局变量 ====================
        // 全局变量 - 使用模板变量直接赋值
        let wordFiles = {{ word_files|tojson|safe }};
        let imageFiles = {{ image_files|tojson|safe }};
        let currentConfig = {};
        let resultWordPath = ''; // 存储选择的Word输出路径
        let resultPdfPath = ''; // 存储选择的PDF输出路径
        let extractedImagesFolderPath = ''; // 存储从PDF提取的图片文件夹路径

        // 初始化输出路径，并在加载时检查后端会话（用于清理缓存）
        window.addEventListener('load', function() {
            fetch('/api/session-id')
            .then(r => r.json())
            .then(data => {
                try {
                    const serverSession = data.session_id;
                    const localSession = localStorage.getItem('app_session_id');
                    if (!localSession || localSession !== serverSession) {
                        // 清除与应用相关的缓存键
                        const keys = [
                            'stamp_overlay_WORD_FOLDER',
                            'stamp_overlay_PDF_FILE',
                            'stamp_overlay_WORD_FILES',
                            'stamp_overlay_IMAGE_FILES',
                            'stamp_overlay_EXTRACTED_FOLDER',
                            'stamp_overlay_RESULT_WORD_PATH',
                            'stamp_overlay_RESULT_PDF_PATH',
                            'stamp_overlay_CONFIG'
                        ];
                        keys.forEach(k => localStorage.removeItem(k));
                        localStorage.setItem('app_session_id', serverSession);
                    }
                } catch (e) {
                    console.warn('session check failed', e);
                }

                // 先加载缓存的数据
                loadFromCache();

                // 从服务器获取默认输出路径（如果没有缓存）
                fetch('/api/get-default-output-paths', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 只有在没有缓存值时才使用默认值
                        if (!resultWordPath && data.result_word_path) {
                            resultWordPath = data.result_word_path;
                            document.getElementById('resultWordPath').value = resultWordPath;
                            saveToCache();
                        }
                        if (!resultPdfPath && data.result_pdf_path) {
                            resultPdfPath = data.result_pdf_path;
                            document.getElementById('resultPdfPath').value = resultPdfPath;
                            saveToCache();
                        }
                    }
                })
                .catch(error => {
                    console.error('获取默认输出路径失败:', error);
                });
            })
            .catch(err => console.error('session check failed', err));
        });

        // 重置Word输出路径为默认
        function resetResultWordPath() {
            fetch('/api/get-default-output-paths', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.result_word_path) {
                    resultWordPath = data.result_word_path;
                    document.getElementById('resultWordPath').value = resultWordPath;
                    saveToCache();
                }
            })
            .catch(error => {
                console.error('获取默认输出路径失败:', error);
            });
        }

        // 重置PDF输出路径为默认
        function resetResultPdfPath() {
            fetch('/api/get-default-output-paths', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.result_pdf_path) {
                    resultPdfPath = data.result_pdf_path;
                    document.getElementById('resultPdfPath').value = resultPdfPath;
                    saveToCache();
                }
            })
            .catch(error => {
                console.error('获取默认输出路径失败:', error);
            });
        }

        // 浏览Word输出文件夹
        function browseResultWordFolder() {
            const folderPath = prompt('请输入Word输出文件夹路径（例如：D:\\Results）:');
            if (folderPath) {
                resultWordPath = folderPath;
                document.getElementById('resultWordPath').value = resultWordPath;
                saveToCache();
            }
        }

        // 浏览PDF输出文件夹
        function browseResultPdfFolder() {
            const folderPath = prompt('请输入PDF输出文件夹路径（例如：D:\\Results）:');
            if (folderPath) {
                resultPdfPath = folderPath;
                document.getElementById('resultPdfPath').value = resultPdfPath;
                saveToCache();
            }
        }

        // ==================== 文件夹扫描函数 ====================

        // 浏览Word文件夹
        async function browseWordFolder() {
            const folderPath = prompt('请输入Word文件夹路径（例如：D:\\data\\Word）:');
            if (folderPath) {
                document.getElementById('wordFolderPath').value = folderPath;
                saveToCache();
            }
        }

        // 浏览PDF文件
        async function browsePdfFile() {
            const pdfPath = prompt('请输入PDF文件路径（例如：D:\\stamps\\stamp.pdf）:');
            if (pdfPath) {
                document.getElementById('pdfFilePath').value = pdfPath;
                saveToCache();
            }
        }

        // 从PDF提取图片
        async function extractPdfImages() {
            const pdfPath = document.getElementById('pdfFilePath').value.trim();
            const statusDiv = document.getElementById('pdfExtractionStatus');
            const spinner = document.getElementById('loadingSpinner');

            if (!pdfPath) {
                statusDiv.className = 'scan-status error';
                statusDiv.textContent = '请输入PDF文件路径';
                return;
            }

            spinner.style.display = 'flex';
            statusDiv.textContent = '';

            try {
                const response = await fetch('/api/extract-pdf-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ pdf_path: pdfPath })
                });

                const data = await response.json();
                spinner.style.display = 'none';

                if (data.success) {
                    imageFiles = data.image_files || [];
                    extractedImagesFolderPath = data.output_folder; // 保存提取的图片文件夹路径
                    statusDiv.className = 'scan-status success';
                    statusDiv.textContent = `✅ 成功提取 ${imageFiles.length} 张图片到: ${data.output_folder}`;
                    // 重新初始化配置表格
                    initializeConfigTable();
                    // 保存缓存
                    saveToCache();
                } else {
                    statusDiv.className = 'scan-status error';
                    statusDiv.textContent = '提取失败: ' + data.error;
                }
            } catch (error) {
                spinner.style.display = 'none';
                statusDiv.className = 'scan-status error';
                statusDiv.textContent = '提取出错: ' + error.message;
            }
        }

        // 扫描Word文件
        async function scanWordFiles() {
            const folderPath = document.getElementById('wordFolderPath').value.trim();
            const statusDiv = document.getElementById('wordScanStatus');
            const spinner = document.getElementById('loadingSpinner');

            if (!folderPath) {
                statusDiv.className = 'scan-status error';
                statusDiv.textContent = '请输入文件夹路径';
                return;
            }

            spinner.style.display = 'flex';
            statusDiv.textContent = '';

            try {
                const response = await fetch('/api/scan-folder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ path: folderPath })
                });

                const data = await response.json();
                spinner.style.display = 'none';

                if (data.success) {
                    wordFiles = data.files;
                    statusDiv.className = 'scan-status success';
                    statusDiv.textContent = `成功扫描到 ${wordFiles.length} 个Word文件`;
                    // 重新初始化配置表格
                    initializeConfigTable();
                    // 保存缓存
                    saveToCache();
                } else {
                    statusDiv.className = 'scan-status error';
                    statusDiv.textContent = '扫描失败: ' + data.error;
                }
            } catch (error) {
                spinner.style.display = 'none';
                statusDiv.className = 'scan-status error';
                statusDiv.textContent = '扫描出错: ' + error.message;
            }
        }

        // 扫描Word目录和图片目录（调用后端 /api/scan-folder-with-images）
        async function scanFolderWithImages() {
            const folderPath = document.getElementById('wordFolderPath').value.trim();
            const statusDiv = document.getElementById('wordScanStatus');
            const spinner = document.getElementById('loadingSpinner');

            if (!folderPath) {
                statusDiv.className = 'scan-status error';
                statusDiv.textContent = '请输入Word文件夹路径';
                return;
            }

            // 图片文件夹优先使用已提取的路径，否则询问用户
            let imageFolder = extractedImagesFolderPath || '';
            if (!imageFolder) {
                imageFolder = prompt('请输入图片文件夹路径（可选，留空表示仅扫描Word）:');
                if (!imageFolder) imageFolder = '';
            }

            spinner.style.display = 'flex';
            statusDiv.textContent = '';

            try {
                const response = await fetch('/api/scan-folder-with-images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ word_path: folderPath, image_path: imageFolder })
                });

                const data = await response.json();
                spinner.style.display = 'none';

                if (data.success) {
                    wordFiles = data.word_files || [];
                    imageFiles = data.image_files || [];

                    statusDiv.className = 'scan-status success';
                    statusDiv.textContent = `成功加载 ${wordFiles.length} 个Word文件 和 ${imageFiles.length} 张图片`;

                    // 如果后端返回了一个图片输出文件夹路径，保存到 extractedImagesFolderPath
                    if (data.output_folder) {
                        extractedImagesFolderPath = data.output_folder;
                    }

                    // 重新初始化配置表格并保存缓存
                    initializeConfigTable();
                    saveToCache();
                } else {
                    statusDiv.className = 'scan-status error';
                    statusDiv.textContent = '扫描失败: ' + data.error;
                }
            } catch (error) {
                spinner.style.display = 'none';
                statusDiv.className = 'scan-status error';
                statusDiv.textContent = '扫描出错: ' + error.message;
            }
        }


        // ==================== 配置表格函数 ====================


        // 添加配置行
        function addConfigRow(wordFile, wordIndex) {
            const tbody = document.getElementById('config-table-body');
            const row = document.createElement('tr');
            row.dataset.wordIndex = wordIndex;

            // Word文件列
            const wordCell = document.createElement('td');
            wordCell.innerHTML = `<div class="word-file-title">${wordFile.name}</div>`;

            // 图片配置列
            const imageCell = document.createElement('td');
            const imageConfig = document.createElement('div');
            imageConfig.className = 'image-config-group';

            // 计算当前应该分配的图片索引
            // 前一个word的索引总和：0 + wordIndex
            addImageConfigItem(imageConfig, wordFile, wordIndex); // 按顺序分配图片，第n个word对应第n张图片
            imageCell.appendChild(imageConfig);

            // 操作列
            const actionCell = document.createElement('td');
            const addBtn = document.createElement('button');
            addBtn.className = 'btn';
            addBtn.textContent = '+';
            addBtn.onclick = (e) => {
                e.stopPropagation();

                // 计算下一个图片索引：当前已有的图片数量 + wordIndex
                const nextImageIndex = imageConfig.children.length + wordIndex;
                addImageConfigItem(imageConfig, wordFile, nextImageIndex);
            };

            actionCell.appendChild(addBtn);

            // 合并Word文件和图片配置列
            const mergedCell = document.createElement('td');

            // 创建垂直布局
            const verticalLayout = document.createElement('div');
            verticalLayout.className = 'vertical-layout';

            // 添加Word文件信息在第一行
            verticalLayout.appendChild(wordCell);

            // 添加图片配置区域在其下方
            verticalLayout.appendChild(imageConfig);

            mergedCell.appendChild(verticalLayout);

            row.appendChild(mergedCell);
            row.appendChild(actionCell);
            tbody.appendChild(row);
        }

        // 添加图片配置项
        function addImageConfigItem(container, wordFile, imageIndex) {
            const imageConfigItem = document.createElement('div');
            imageConfigItem.className = 'image-config-item';

            // 图片选择
            const imageSelect = document.createElement('select');
            imageSelect.className = 'image-select';

            // 默认选项
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = '选择图片';
            imageSelect.appendChild(defaultOption);

            // 图片选项
            imageFiles.forEach((imageFile, idx) => {
                const option = document.createElement('option');
                option.value = imageFile;
                option.textContent = imageFile;

                // 默认按顺序选择：第一个word对应第imageIndex+1张图片
                // 例如，第n个word添加第k个图片配置项，对应图片索引为imageIndex + k
                if (idx === imageIndex) {
                    option.selected = true;
                }

                imageSelect.appendChild(option);
            });

            // 插入位置
            const positionInput = document.createElement('input');
            // 仅接受数值页码
            positionInput.type = 'number';
            positionInput.className = 'page-input';
            positionInput.placeholder = '插入位置（页码）';
            // 优先使用扫描时提取的页数（兼容不同字段名），若无则使用 1（第一页）
            let wf = {};
            if (typeof wordFile === 'string') {
                wf = wordFiles.find(word => word.name === wordFile) || {};
            } else if (wordFile && wordFile.name) {
                // 如果传入的是对象（来自server扫描结果），直接使用该对象
                wf = wordFile;
            }
            const defaultPage = wf.page_count || wf.total_pages || wf.totalPages || null;
            positionInput.value = defaultPage !== null && defaultPage !== undefined ? String(defaultPage) : '1';

            // 删除按钮
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-danger';
            deleteBtn.textContent = '删除';
            // use existing btn and btn-danger classes; add btn-sm for compact size
            deleteBtn.classList.add('btn-sm');
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                // 至少保留一个图片配置
                if (container.children.length > 1) {
                    container.removeChild(imageConfigItem);
                }
            };

            imageConfigItem.appendChild(imageSelect);
            imageConfigItem.appendChild(document.createTextNode(' '));
            imageConfigItem.appendChild(document.createTextNode('插入位置：'));
            imageConfigItem.appendChild(positionInput);
            imageConfigItem.appendChild(document.createTextNode(' '));
            imageConfigItem.appendChild(deleteBtn);

            container.appendChild(imageConfigItem);
        }

        // 生成默认配置
        function generateDefaultConfig() {
            const tbody = document.getElementById('config-table-body');
            tbody.innerHTML = '';

            // 按顺序一一对应，确保一个word对应一个图片
            wordFiles.forEach((wordFile, index) => {
                addConfigRow(wordFile, index);
            });

            updateConfig();
            alert('默认配置已生成');
        }

        // 更新配置
        function updateConfig() {
            const config = {};

            // 遍历所有配置行
            const rows = document.querySelectorAll('#config-table-body tr');
            rows.forEach((row) => {
                const wordFile = row.querySelector('td:first-child').textContent.trim();
                const imageConfigItems = row.querySelectorAll('.image-config-item');

                const images = [];

                // 遍历图片配置
                imageConfigItems.forEach((item) => {
                    const imageSelect = item.querySelector('.image-select');
                    const positionInput = item.querySelector('.page-input');

                    const imageFile = imageSelect.value;
                    // 处理插入位置：始终转换为数值页码，若无效则使用该Word文件的总页数或1
                    let position = parseInt(positionInput.value);
                    if (isNaN(position) || position < 1) {
                        const wf = wordFiles.find(w => w.name === wordFile) || {};
                        const defaultPage = wf.page_count || wf.total_pages || wf.totalPages || 1;
                        position = defaultPage;
                    }

                    if (imageFile) {
                        images.push({
                            image: imageFile,
                            position: position
                        });
                    }
                });

                if (images.length > 0) {
                    config[wordFile] = images;
                }
            });

            currentConfig = config;

            // 更新所有图片选择下拉框，移除已被选择的图片
            updateImageSelectOptions();

            // 如果配置预览元素存在则更新
            const preview = document.getElementById('config-preview');
            if (preview) {
                preview.textContent = JSON.stringify(config, null, 2);
            }
            
            // 保存缓存
            saveToCache();
        }

        // 更新图片选择下拉框，移除已被选择的图片
        function updateImageSelectOptions() {
            // 收集所有已被选择的图片
            const usedImages = new Set();

            // 遍历所有配置行
            const rows = document.querySelectorAll('#config-table-body tr');
            rows.forEach((row) => {
                const imageConfigItems = row.querySelectorAll('.image-config-item');

                // 遍历图片配置
                imageConfigItems.forEach((item) => {
                    const imageSelect = item.querySelector('.image-select');
                    const selectedImage = imageSelect.value;

                    if (selectedImage) {
                        usedImages.add(selectedImage);
                    }
                });
            });

            // 更新所有下拉框
            const allImageSelects = document.querySelectorAll('.image-select');
            allImageSelects.forEach((select) => {
                // 当前下拉框的选中值
                const currentSelected = select.value;

                // 保存当前选中值，防止被清除
                let keepCurrent = false;

                // 遍历所有选项
                Array.from(select.options).forEach((option) => {
                    if (option.value === '') {
                        // 保留默认选项
                        return;
                    }

                    if (usedImages.has(option.value)) {
                        // 如果图片已被其他地方选择，并且不是当前下拉框的选中值，则禁用
                        if (option.value !== currentSelected) {
                            option.disabled = true;
                            option.textContent = option.value + ' (已选择)';
                        } else {
                            keepCurrent = true;
                            option.disabled = false;
                            option.textContent = option.value;
                        }
                    } else {
                        // 图片未被选择，启用
                        option.disabled = false;
                        option.textContent = option.value;
                    }
                });
            });
        }

        // 为所有图片选择框添加change事件监听
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化配置表格
            initializeConfigTable();

            // 添加事件监听
            const body = document.body;

            // 使用事件委托监听图片选择变化
            body.addEventListener('change', function(e) {
                if (e.target && e.target.className === 'image-select') {
                    updateConfig();
                }
            });
        });

        // 保存配置（返回Promise以便调用者等待）
        function saveConfig() {
            const resultDiv = document.getElementById('result');
            // 在发送前对 currentConfig 做清洗：确保所有插入页为有效数值且不为 null
            const sanitizedConfig = {};
            Object.keys(currentConfig || {}).forEach((wordName) => {
                const items = currentConfig[wordName] || [];
                const wf = (wordFiles || []).find(w => (typeof w === 'string' ? w === wordName : w.name === wordName)) || {};
                const defaultPage = wf.page_count || wf.total_pages || wf.totalPages || 1;

                sanitizedConfig[wordName] = items.map(it => {
                    // 支持两种字段名：position 或 page
                    let pageVal = it.position != null ? it.position : it.page;
                    let page = parseInt(pageVal);
                    if (isNaN(page) || page < 1) {
                        page = defaultPage || 1;
                    }
                    return {
                        image: it.image,
                        position: page
                    };
                });
            });

            // 组装完整的数据结构，以匹配后端默认文件里的三段式结构（兼容后端）
            const payload = {
                target_files: (wordFiles || []).map(w => (typeof w === 'string' ? w : w.name)),
                images: (imageFiles || []).map(i => i),
                config: sanitizedConfig
            };

            return fetch('/api/func2/data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = '<p class="result-success">配置保存成功！</p>';
                } else {
                    resultDiv.innerHTML = '<p class="result-error">配置保存失败：' + data.error + '</p>';
                }
                return data;
            })
            .catch(error => {
                resultDiv.innerHTML = '<p class="result-error">配置保存失败：' + error.message + '</p>';
                throw error;
            });
        }

        // 开始处理
        async function startProcessing() {
            const resultDiv = document.getElementById('result');
            
            // 验证Word文件夹
            const wordFolderPath = document.getElementById('wordFolderPath').value.trim();
            if (!wordFolderPath) {
                resultDiv.innerHTML = '<p class="result-error">请先选择Word文件夹</p>';
                return;
            }
            
            // 验证是否有扫描到的Word文件
            if (!wordFiles || wordFiles.length === 0) {
                resultDiv.innerHTML = '<p class="result-error">请先扫描Word文件</p>';
                return;
            }
            
            // 验证是否有提取的图片
            if (!imageFiles || imageFiles.length === 0) {
                resultDiv.innerHTML = '<p class="result-error">请先从PDF提取图片</p>';
                return;
            }
            
            // 在开始前保存当前配置到后端，确保后端使用最新配置
            try {
                await saveConfig();
            } catch (e) {
                resultDiv.innerHTML = '<p class="result-error">保存配置失败，无法开始处理</p>';
                return;
            }

            // 验证输出路径
            const resultWordPathValue = document.getElementById('resultWordPath').value.trim();
            const resultPdfPathValue = document.getElementById('resultPdfPath').value.trim();
            
            if (!resultWordPathValue || !resultPdfPathValue) {
                resultDiv.innerHTML = '<p class="result-error">请选择输出路径</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p class="result-info">正在覆盖中...</p>';

            fetch('/api/start-stamp-overlay', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    target_word_dir: wordFolderPath,
                    images_folder: extractedImagesFolderPath, // 传递提取的图片文件夹路径
                    result_word_path: resultWordPathValue,
                    result_pdf_path: resultPdfPathValue
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = '<p class="result-success">覆盖完成！结果已生成。</p>';
                } else {
                    resultDiv.innerHTML = '<p class="result-error">覆盖失败：' + data.error + '</p>';
                }
            })
            .catch(error => {
                resultDiv.innerHTML = '<p class="result-error">覆盖失败：' + error.message + '</p>';
            });
        }

        // 初始化配置表格
        function initializeConfigTable() {
            const tbody = document.getElementById('config-table-body');
            tbody.innerHTML = '';

            // 如果有Word文件，生成默认行
            if (wordFiles.length > 0) {
                wordFiles.forEach((wordFile, index) => {
                    addConfigRow(wordFile, index);
                });
            }
        }

        // 打开指定目录
        function openDirectory(dirName) {
            // 调用API打开目录，不显示提示
            fetch(`/api/open-directory?dir_name=${encodeURIComponent(dirName)}`)
                .then(response => response.json())
                .then(data => {
                    // 不显示任何提示
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        // 刷新Word文件列表
        function refreshWordFiles() {
            // 简单的刷新方式是重新加载页面
            window.location.reload();
        }

        // 刷新图片文件列表
        function refreshImageFiles() {
            // 简单的刷新方式是重新加载页面
            window.location.reload();
        }

        // 从PDF提取图片
        function extractImagesFromPdf() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<p class="result-info">正在从PDF提取图片...</p>';

            fetch('/api/extract-images-from-pdf', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = '<p class="result-success">图片提取完成！共提取 ' + data.count + ' 张图片</p>';
                    // 刷新页面
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    resultDiv.innerHTML = '<p class="result-error">图片提取失败：' + data.error + '</p>';
                }
            })
            .catch(error => {
                resultDiv.innerHTML = '<p class="result-error">图片提取失败：' + error.message + '</p>';
            });
        }

        // 终止服务并关闭页面
        function shutdownServer() {
            if (confirm('确定要终止服务并关闭页面吗？')) {
                fetch('/api/shutdown', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('服务已终止，请关闭页面');
                        window.close();
                    } else {
                        alert('终止服务失败: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('终止服务失败');
                });
            }
        }
    </script>
</body>
</html>